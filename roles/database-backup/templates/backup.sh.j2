#!/bin/sh

set -e

logPrefix(){
  echo "$(date --iso-8601=seconds) - {{ openstack_container_name }} -"
}
DATABASE_NAME={{ database_name }}

echo "$(logPrefix) Backing up database $DATABASE_NAME..."

echo "$(logPrefix) Creating encrypted dump of database $DATABASE_NAME..."
TIMESTAMP=$(date +'%Y%m%d%H%M%S')
BACKUP_FILE_NAME=pg_dump_${DATABASE_NAME}_${TIMESTAMP}.sql.pgp
TEMP_PATH=/tmp/${BACKUP_FILE_NAME}

pg_dump --clean --format=custom {{ database_name }} | gpg2 --recipient {{ gpg_recipient }} --encrypt --always-trust --output ${TEMP_PATH}

echo "$(logPrefix) Uploading backup file to remote server..."
export OS_AUTH_URL="{{ openstack_auth_url }}"
export OS_TENANT_ID="{{ openstack_tenant_id }}"
export OS_TENANT_NAME="{{ openstack_tenant_name }}"
export OS_USERNAME="{{ openstack_username }}"
export OS_PASSWORD="{{ openstack_password }}"
export OS_REGION_NAME="{{ openstack_region_name }}"

/usr/local/bin/swift upload {{ openstack_container_name }} ${TEMP_PATH} --object-name ${BACKUP_FILE_NAME} -V 2

echo "$(logPrefix) Erasing local copy of backup file..."
shred -u -z ${TEMP_PATH}

echo "$(logPrefix) Database $DATABASE_NAME successfully backed up!"
